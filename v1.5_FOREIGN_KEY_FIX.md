# v1.5 - Foreign Key Constraint Fix & Enhanced Diagnostics

## 🐛 Problema Segnalato

Gli utenti ricevevano l'errore:

```
Expense error: {
  code: '23503',
  message: 'insert or update on table "expenses" violates foreign key constraint "expenses_user_id_fkey"'
}
```

Il problema: **L'utente non veniva creato nella tabella `public.users` di Supabase**.

---

## ✅ Soluzioni Implementate

### 1. **Enhanced Error Logging**

#### `src/pages/signup.tsx`

- ✅ Aggiunto console logging dettagliato per il processo di signup
- ✅ Controllo esplicito se l'insert nel `users` table fallisce
- ✅ Mostra codice errore e dettagli all'utente
- ✅ Interrompe il signup se l'utente non viene creato su Supabase

#### `src/pages/login.tsx`

- ✅ Aggiunto controllo che il user esista in `public.users`
- ✅ Se non esiste, tenta di crearlo al login
- ✅ Logging dettagliato di successo/fallimento
- ✅ Gestione corretta dell'errore PGRST116 (not found)

### 2. **Sync Service Query Fixes** (da v1.4.1)

**Problema**: Le query GET con `.select('id').eq('id', ...).single()` generavano 406 Not Acceptable

**Soluzione**:

- ✅ Cambiato `.select('id')` → `.select('*')`
- ✅ Aggiunto controllo per `checkError.code !== 'PGRST116'`
- ✅ Differenziazione tra "not found" (normal) e veri errori

### 3. **Sync Result Validation** (da v1.4.1)

**Problema**: Il codice stampava "sync riuscito" anche se falliva

**Soluzione**:

- ✅ Controllo esplicito di `syncResult.success`
- ✅ Messaggi di errore mostruati all'utente
- ✅ Alert giallo per warning/sync parziali

---

## 📚 Documentation

### Nuovo File: `SYNC_ERROR_DIAGNOSTICS.md`

Guida completa per diagnosticare e risolvere il problema:

1. **Diagnostica step-by-step** per capire dove fallisce
2. **Tre soluzioni** da provare in ordine
3. **RLS Policies SQL** da copiare-incollare su Supabase
4. **Checklist** di verifica
5. **Procedure di test** per validare il fix

---

## 🎯 Come Risolvere Ora

### Opzione 1: Disabilitare RLS (Quick Fix - SOLO DEV)

Nel Supabase Dashboard:

1. Table Editor → `users` → ... → Disable RLS

### Opzione 2: Configurare RLS Policies (Consigliato)

Nel Supabase SQL Editor, copiar le policies da `SYNC_ERROR_DIAGNOSTICS.md` Option B

### Opzione 3: Policy Permissiva (Fallback - SOLO DEV)

Copiare le policies da `SYNC_ERROR_DIAGNOSTICS.md` Option C

---

## 🧪 Come Testare il Fix

1. **Apri DevTools** (F12) → Console
2. **Fai signup** nuovo
3. Guarda i log:
   - `📝 Attempting to create user in Supabase...`
   - `✅ User created successfully in Supabase` (successo!)
   - o errore con codice
4. **Aggiungi spesa** e verifica sync

---

## 📊 Impatto

- ✅ Errori now properly reported to user
- ✅ Foreign key issues now caught at signup time (not sync time)
- ✅ Detailed logging for debugging
- ✅ Comprehensive diagnostics guide
- ⚠️ Richiede configurazione RLS su Supabase (vedi SYNC_ERROR_DIAGNOSTICS.md)

---

## 📝 File Modificati

- `src/pages/signup.tsx` - Error handling + detailed logging
- `src/pages/login.tsx` - User verification + detailed logging
- `src/services/sync.service.ts` - Query fixes (from v1.4.1)
- `src/components/expense/expense-form.tsx` - Sync validation (from v1.4.1)
- `SYNC_ERROR_DIAGNOSTICS.md` - NEW - Complete troubleshooting guide

---

## 🚀 Next Steps

1. Leggi `SYNC_ERROR_DIAGNOSTICS.md`
2. Configura RLS policies su Supabase (scegli Opzione 1, 2, o 3)
3. Testa il signup nuovo
4. Verifica che le spese sincronizzino correttamente

Allega questo messaggio e i log della console quando reporti bug! 📸
